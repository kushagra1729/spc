{% load static %}

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Your Drive</title>   
        {% load static %}
        <title>Minimal Django File Upload Example</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
        <meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel='stylesheet' href='https://use.fontawesome.com/releases/v5.5.0/css/all.css' integrity='sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU' crossorigin='anonymous'>
        <script type="text/javascript" src="https://cdn.rawgit.com/ricmoo/aes-js/e27b99df/index.js"></script>

        <script type="text/javascript" src="https://cdn.rawgit.com/ricmoo/aes-js/e27b99df/index.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.js"></script>
        <script src="https://www.cse.iitb.ac.in/~onkard/arc4.js"></script>
        <script src="http://sladex.org/blowfish.js/ext/blowfish.js"></script>
        <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
        <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
        <script>
            function str2ab(str) {
                var buf = new ArrayBuffer(str.length); // 2 bytes for each char
                var bufView = new Uint8Array(buf);
                for (var i=0, strLen=str.length; i<strLen; i++) {
                    bufView[i] = str.charCodeAt(i);
                }
                return buf;
            }

            var appendBuffer = function(buffer1, buffer2) {
                var tmp = new Uint8Array(buffer1.byteLength + buffer2.byteLength);
                tmp.set(new Uint8Array(buffer1), 0);
                tmp.set(new Uint8Array(buffer2), buffer1.byteLength);
                return tmp.buffer;
            };

            /////////////////////////////////////////////////////////////////////////
            /////////////////////////////////////////////////////////////////////////
            //DECRYPTION FUNCTIONS BEGIN

            function decryptAES(ciphertext,key){
                var iv = ciphertext.slice(0,16);
                var key = new Uint8Array(sha256.arrayBuffer(str2ab(key)));
                var aesCbc = new aesjs.ModeOfOperation.cbc(key, iv);
                var decryptedBytes = aesCbc.decrypt(ciphertext.slice(16));
                var sl = 0 - decryptedBytes.slice(-1);
                return decryptedBytes.slice(0,sl);
            }
            function decryptARC(ciphertext,key){
                var iv = ciphertext.slice(0,16);
                var k = sha256.array(appendBuffer(str2ab(key),iv));
                k = String.fromCharCode.apply("", k);
                var cipher = new ARC4(k);
                return cipher.decrypt(String.fromCharCode.apply("", ciphertext.slice(16)));
            }
            function decryptBF(ciphertext,key){
                var c =  blowfish['decrypt'](ciphertext,key,{outputType: 3, cipherMode: 1});
                return c.slice(8);
            }

            //DECRYPTION FUNCTIONS END
            /////////////////////////////////////////////////////////////////////////
            /////////////////////////////////////////////////////////////////////////

            var modal = document.getElementById('myModal');

            function decrypt(){
                var fileurl = '';
                var scheme = '';
                var vd = '';
                var key;

                fileurl = document.files.fileurl.value;
                scheme = document.files.scheme.value;
                vd = document.files.vd.value;
                key = document.files.key.value;

                var oReq = new XMLHttpRequest();
                oReq.open("GET", fileurl, true);
                oReq.responseType = "arraybuffer";
                var filetxt = "Loading...";
                oReq.onload = function(oEvent) {
                    filetxt = new Uint8Array(oReq.response);
                    if (scheme == "AES") {
                        filetxt = decryptAES(filetxt,key);
                    } else if (scheme == "ARC") {
                        filetxt = decryptARC(filetxt,key);
                    } else {
                        filetxt = decryptBF(filetxt,key);
                        filetxt = str2ab(filetxt);
                    }
                    fileblob = new Blob([new Uint8Array(filetxt)]);
                    file = window.URL.createObjectURL(fileblob);

                    var re = /(?:\.([^.]+))?$/;
                    var ext = re.exec(fileurl)[1];

                    var a = document.createElement("a");
                    a.href = file;
                    a.download = fileurl.match(/([^\/]*)\/*$/)[1];//filename
                    document.body.appendChild(a);
                    if (vd == "view"){
                        modal.style.display = "block";
                        if (ext == "txt") {
                            document.getElementById("mcont").innerHTML = "<embed type='text/plain' src='" + file + "' width='1500px' height='700px' scale='tofit'/>";
                        }else if (ext == "jpg") {
                            document.getElementById("mcont").innerHTML = "<embed type='image/jpeg' src='" + file + "'width='1500px' height='700px' scale='tofit'/>";
                        } else if (ext == "mp4") {
                            document.getElementById("mcont").innerHTML = "<embed type='video/mp4' src='" + file + "'width='1500px' height='700px' scale='tofit'/>";
                        } else {
                            document.getElementById("mcont").innerHTML = "<embed src='" + file + "'width='1500px' height='700px' scale='tofit'/>";
                        }
                    } else a.click();

                };
                oReq.send();
                document.getElementById("files").reset();
                return false;
            }
        </script>
    </head>
    <style>
    .sidenav {
    height: 100%;
    width: 0;
    position: fixed;
    z-index: 1;
    top: 0;
    left: 0;
    background-color: #111;
    overflow-x: hidden;
    transition: 0.5s;
    padding-top: 60px;
}

.sidenav a {
    padding: 8px 8px 8px 32px;
    text-decoration: none;
    font-size: 25px;
    color: #818181;
    display: block;
    transition: 0.3s;
}

.sidenav a:hover {
    color: #f1f1f1;
}

.sidenav .closebtn {
    position: absolute;
    top: 0;
    right: 40px;
    font-size: 36px;
    margin-left: 50px;
}

@media screen and (max-height: 450px) {
  .sidenav {padding-top: 15px;}
  .sidenav a {font-size: 18px;}
}
    .hbutton {
    position: fixed;

    top: 0px;
    right: 0px;
}
 .hb{
    color: black;
     background-color: greenyellow  ;
        padding: 8px 12px;
        margin: 8px 0;
 }
    .hbutton2 {
    position: fixed;
    top: 60px;
    right: 0px;
}
      button {
        background-color: greenyellow;
        color: black;
        padding: 10px 16px;
        margin: 8px 0;
        border: none;
        cursor: pointer;
        width: 100%;
    }

    button:hover {
        opacity: 0.8;
    }
        .bg {
            /* The image used */
            background-image: url("{% static 'images/as.jpg' %}");

            /* Full height */
            height: 100%;

            /* Center and scale the image nicely */
            background-position: center;
            background-repeat: no-repeat;
            background-size: cover;
        }
.cancelbtn {
    width: auto;
    padding: 10px 18px;
    background-color: #f44336;
}

/* Center the image and position the close button */
.imgcontainer {
    text-align: center;
    margin: 24px 0 12px 0;
    position: relative;
}

img.avatar {
    width: 40%;
    border-radius: 50%;
}

.container {
    padding: 40px;

}

span.psw {
    float: right;
    padding-top: 16px;
}

/* The Modal (background) */
.modal {
    display: none; /* Hidden by default */
    position: fixed; /* Stay in place */
    z-index: 1; /* Sit on top */
    left: 0;
    top: 0;
    width: 100%; /* Full width */
    height: 100%; /* Full height */
    overflow: auto; /* Enable scroll if needed */
    background-color: rgb(0,0,0); /* Fallback color */
    background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
    padding-top: 60px;
}

/* Modal Content/Box */
.modal-content {
    background-color: #fefefe;
    margin: 5% auto 15% auto; /* 5% from the top, 15% from the bottom and centered */
    border: 1px solid #888;
    width: 80%; /* Could be more or less, depending on screen size */
}

/* The Close Button (x) */
.close {
    position: absolute;
    right: 25px;
    top: 0;
    color: #000;
    font-size: 35px;
    font-weight: bold;
}

.close:hover,
.close:focus {
    color: red;
    cursor: pointer;
}

/* Add Zoom Animation */
.animate {
    -webkit-animation: animatezoom 0.6s;
    animation: animatezoom 0.6s
}

@-webkit-keyframes animatezoom {
    from {-webkit-transform: scale(0)} 
    to {-webkit-transform: scale(1)}
}
    
@keyframes animatezoom {
    from {transform: scale(0)} 
    to {transform: scale(1)}
}

/* Change styles for span and cancel button on extra small screens */
@media screen and (max-width: 300px) {
    span.psw {
       display: block;
       float: none;
    }
    .cancelbtn {
       width: 100%;
    }
}
body, html {
    height: 100%;
    margin: 0;
}

.bg {
    /* The image used */
    background-image: url("{% static 'images/as.jpg' %}");

    /* Full height */
    height: 100%; 

    /* Center and scale the image nicely */
    background-position: center;
    background-repeat: repeat;
    background-size: cover;
}
.helper{
    height: 400px;
  line-height: 600px;
  text-align: center;
}
/*div {
 height: 400px;
  line-height: 600px;
  text-align: center;
}*/


    </style>
<body class="bg">

	<script>
		function openNav() {
		    document.getElementById("mySidenav").style.width = "250px";
		}

		function closeNav() {
		    document.getElementById("mySidenav").style.width = "0";
		}
	</script>

	<span style="font-size:40px;cursor:pointer" onclick="openNav()">&#9776; </span>
	<center>
	    <h1 > <font color="DimGrey"> Secure Personal Cloud </font> </h1>
	    <h1 > <font color="DimGrey"> Welcome {{ request.user }} </font> </h1>
	</center>

	<div id="mySidenav" class="sidenav">
	    <a href="#" > Secure Personal Cloud </a>
	    <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
	    <a href="/server/upload">Home</a>
	    <a href="/accounts/logout">Logout</a>
	    <a href="/accounts/change-password">Change Password</a>
	</div>

	<div class="container">
	    {% if documents %}
	        <form id="files" name="files" onSubmit="return decrypt()">
	        	<div class="row">
	        		<div class="col">
		        	<div class="form-group">
		        		<label for="filename">Files</label>
		        		<select multiple class="form-control" style="height:200px" id="fileurl" name="fileurl">
			            {% for document in documents %}
			                <option value="{% url "db_file_storage.download_file" %}?name={{ document.docfile }}" id="radbtn{{ document.docfile.name }}" >
			                    {{ document.docfile.name }}
			                </option>
			            {% endfor %}
			        	</select>
			        </div>
			        </div>

		        
		        
		        	<div class="col">
		        		<br>
		        	<div class="form-group">
			        	<div class="form-check form-check-inline">
                            <h6> Encryption Schemes </h6>
				            <input id="s1" class="form-check-input" type="radio" name="scheme" value="AES" checked="checked"> <label class="form-check-label" for="s1">AES</label> 
				            <input id="s2" class="form-check-input" type="radio" name="scheme" value="ARC"> <label class="form-check-label" for="s2">ARC</label> 
				            <input id="s3" class="form-check-input" type="radio" name="scheme" value="BF"> <label class="form-check-label" for="s3">Blowfish</label>
				    	</div>
			    	</div>
			        <div class="form-group">
					    <label for="key">Encryption Key</label>
					    <input name="key" type="text" class="form-control" id="key" placeholder="Secret Key(4 to 52 characters)">
					</div>
					<div class="form-check form-check-inline">
			            <input id="view" class="form-check-input" type="radio" name="vd" value="view" checked="checked"> <label class="form-check-label" for="view"><button  style="width:200px";> <i class="fas fa-glasses" > </i>  View </button>  </label> 
			            <!-- <input id="download" class="form-check-input" type="radio" name="vd" value="download"> <label class="form-check-label" for="download">Download</label>  -->
                        <input id="download" class="form-check-input" type="radio" name="vd" value="download"> <button  style="width:200px";> <i class="fa fa-download"></i>Download </span></button><br>
			        </div>
		           <button type="submit" class="hb" value="Submit"  style="width:200px";><i class= "fas fa-save"> </i> Submit </button>
		        	</div>
		        </div>
	        </form>
	    {% else %}
	        <p>No documents.</p>

	    {% endif %}
	</div>

        <!-- The Modal -->
        <div id="myModal" class="modal center" width="100%" height="100%" >
          <!-- Modal content -->
          <div  class="modal-content center" width="100%" height="100%" >
            <span class="close">&times;</span>
            <div id="mcont"></div>
          </div>
        </div>


        <center>


        {% if folders %}
             <h2> Folders</h2>
            <div class="container">
                <div class="container">
            {% for folder in folders %}
                <a href="/server/upload/{{ dir }}{{ folder.name }}/">

                <button style="width:200px; id="myBtn{{ folder.name }}" ><i class="fa fa-folder"></i> {{ folder.name }}</button>
                </a>
            {% endfor %}
        </div>
        </div>

        {% else %}
            <h1>No folders </h1>
        {% endif %}

    </center>


        {% if documents %}

            <script type="text/javascript">
                var modal = document.getElementById('myModal');
                var span = document.getElementsByClassName("close")[0];
                // When the user clicks on <span> (x), close the modal
                span.onclick = function() {
                    modal.style.display = "none";
                }
            </script>

            {% for document in documents %}
                <script>
                    var path = document.getElementById("radbtn{{ document.docfile.name }}");
                    var name = "{{ document.docfile.name }}".match(/([^\/]*)\/*$/)[1];
                    document.getElementById("radbtn{{ document.docfile.name }}").innerHTML = name;
                </script>

            {% endfor %}

        {% endif %}
        <script>
            var modal = document.getElementById('myModal');
            var span = document.getElementsByClassName("close")[0];
            // When the user clicks on <span> (x), close the modal
            span.onclick = function() {
                modal.style.display = "none";
            };
            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            };
        </script>  
    </body>
</html> 
